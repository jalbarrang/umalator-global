---
alwaysApply: false
---

# Uma Musume Race Mechanics Expert Reference

This document provides comprehensive reference for Uma Musume race simulation mechanics. Use this when implementing race solvers, skill systems, data analysis tools, or any code related to race calculations.

## 1. Core Concepts & Constants

### Frame Rate

- Races simulate at **0.0666s per tick** (~15 FPS)
- Positions recorded every 1 second, OR every frame within first 1s of race, OR when within 25m of goal

### Race Structure

- **24 sections** of equal distance (numbered 1-24)
- **4 phases** (numbered 0-3):
  - Phase 0 (Early-race): Sections 1-4
  - Phase 1 (Mid-race): Sections 5-16
  - Phase 2 (Late-race): Sections 17-20
  - Phase 3 (Last Spurt): Sections 21-24

### Units

- **Bashin (horse length)**: 1 Bashin = 2.5m
- **Course Width**: 11.25m
- **Horse Lane**: 1/18 course width = 0.625m
- Maximum lane varies by course (1.1 to 1.5 course width)

### Critical Clamping Rules

- All stats clamped between **1 and 2000** at each stage (base, adjusted, final)
- Target speed cannot go below minimum speed or exceed **30 m/s**
- Lane change actual speed clamped between **0 and 0.6** course width per frame

## 2. Stats System

### Pipeline: Raw → Base → Adjusted → Final

**Raw Stats**: Stats shown in stat panel. Stats past 1200 are halved before being converted to base stats.

**Base Stats**: Raw stats modified by motivation

```
BaseStat = RawStat * MotivationCoef
// Clamped between 1 and 2000
```

### Motivation Coefficients

| Motivation  | 絶好調 | 好調 | 普通 | 不調 | 絶不調 |
| ----------- | ------ | ---- | ---- | ---- | ------ |
| Coefficient | 1.04   | 1.02 | 1.0  | 0.98 | 0.96   |

### Adjusted Stats Formulas

```typescript
AdjustedSpeed = BaseSpeed * RaceCourseModifier + GroundModifier + SingleModeModifier;
AdjustedStamina = BaseStamina + SingleModeModifier;
AdjustedPower = BasePower + GroundModifier + SingleModeModifier;
AdjustedGuts = BaseGuts + SingleModeModifier;
AdjustedWit = BaseWit * StrategyProficiencyModifier + SingleModeModifier;
```

All adjusted stats clamped between 1 and 2000.

### Ground Modifier for Speed

| Surface | Firm | Good | Soft | Heavy |
| ------- | ---- | ---- | ---- | ----- |
| Turf    | 0    | 0    | 0    | -50   |
| Dirt    | 0    | 0    | 0    | -50   |

### Ground Modifier for Power

| Surface | Firm | Good | Soft | Heavy |
| ------- | ---- | ---- | ---- | ----- |
| Turf    | 0    | -50  | -50  | -50   |
| Dirt    | -100 | -50  | -100 | -100  |

### Strategy Proficiency Modifier (for Wisdom)

| S   | A   | B    | C    | D   | E   | F   | G   |
| --- | --- | ---- | ---- | --- | --- | --- | --- |
| 1.1 | 1.0 | 0.85 | 0.75 | 0.6 | 0.4 | 0.2 | 0.1 |

### Race Course Modifier (Threshold Stats)

Some courses have 1-2 threshold stats. Bonus to adjusted speed based on base stat:

- Stat ≤ 300: `+0.05x`
- 300 < Stat ≤ 600: `+0.1x`
- 600 < Stat ≤ 900: `+0.15x`
- 900 < Stat: `+0.2x`

Final modifier = average of all threshold stat modifiers (max `+0.2x` achievable).

## 3. Speed Mechanics

### Base Speed

```typescript
BaseSpeedForDistance = 20.0 - (CourseDistance - 2000) / 1000; // [m/s]
```

Examples:

- 1200m races: `20.8` m/s
- 2000m races: `20.0` m/s
- 2500m races: `19.5` m/s

### Target Speed Formula

```typescript
TargetSpeed =
  (BaseTargetSpeedForPhase or LastSpurtSpeed) * PositionKeepCoef +
  ForceInModifier +
  SkillModifier +
  SlopeModifier +
  MoveLaneModifier;
```

**Clamped**: Cannot go below minimum speed or exceed 30 m/s.

### Base Target Speed (by Phase)

**Early-race (0) and Mid-race (1)**:

```typescript
BaseTargetSpeedForPhase = BaseSpeedForDistance * StrategyPhaseCoef;
```

Note: NOT affected by speed stat in early/mid-race.

**Late-race (2) and Last Spurt (3)**:

```typescript
BaseTargetSpeedForLateRaceAndLastSpurt =
  BaseSpeedForDistance * StrategyPhaseCoef +
  sqrt(500 * SpeedStat) * DistanceProficiencyModifier * 0.002;
```

### Strategy Phase Coefficients (for Target Speed)

| Strategy     | Early-race (0) | Mid-race (1) | Late-race (2) & Last Spurt (3) |
| ------------ | -------------- | ------------ | ------------------------------ |
| Front Runner | 1.0            | 0.98         | 0.962                          |
| Pace Chaser  | 0.978          | 0.991        | 0.975                          |
| Late Surger  | 0.938          | 0.998        | 0.994                          |
| End Closer   | 0.931          | 1.0          | 1.0                            |
| Runaway      | 1.063          | 0.962        | 0.95                           |

### Distance Proficiency Modifier

| S    | A   | B   | C   | D   | E   | F   | G   |
| ---- | --- | --- | --- | --- | --- | --- | --- |
| 1.05 | 1.0 | 0.9 | 0.8 | 0.6 | 0.4 | 0.2 | 0.1 |

### Randomness Per Section

At each section, random speed variation added to target speed:

```typescript
MaxVariation = (WitStat / 5500) * log10(WitStat * 0.1); // [%]
MinVariation = MaxVariation - 0.65; // [%]
RandomModifier = BaseSpeed * Random(MinVariation, MaxVariation);
```

Examples:

- 400 Wit: Max=+0.117%, Min=-0.533%
- 800 Wit: Max=+0.277%, Min=-0.373%

**Does NOT affect last spurt calculation.**

### Last Spurt Calculation

Calculated at beginning of mid-race (Phase 1):

```typescript
LastSpurtSpeedMax =
  (BaseTargetSpeedForLateRaceAndLastSpurt + 0.01 * BaseSpeedForDistance) * 1.05 +
  sqrt(500 * SpeedStat) * DistanceProficiencyModifier * 0.002 +
  pow(450 * GutsStat, 0.597) * 0.0001; // [m/s]
```

**Selection Process**:

1. If HP sufficient to run remaining distance at max speed → use max speed immediately
2. Otherwise, create candidate list by lowering speed by 0.1 m/s per step until reaching base target speed
3. Sort by finish time (sum of distance/speed, ignoring acceleration)
4. Each candidate has `15 + 0.05 * WitStat [%]` chance to be accepted (Wit check)
5. If all fail Wit check, use slowest candidate

**Important Notes**:

- Estimates stamina usage up to 60m before goal
- Does NOT account for acceleration time
- **Recalculates** when HP recovery skill activates after entering late-race
- **Does NOT recalculate** on stamina drain debuffs

### Force-In Modifier

Applied in early-race when >0.12m course width from fence and inside is open:

```typescript
ForceInModifier = Random(0.1) + StrategyModifier; // [m/s]
```

Strategy modifiers:

- Front Runner: +0.02 m/s
- Pace Chaser: +0.01 m/s
- Late Surger: +0.01 m/s
- End Closer: +0.03 m/s

### Move Lane Modifier

Applied when affected by lane move speed skill AND moved lane in previous frame:

```typescript
MoveLaneModifier = pow(0.0002 * PowerStat, 0.5); // [m/s]
```

### Starting Speed

**3 m/s** at race start.

### Minimum Speed

```typescript
MinSpeed = 0.85 * BaseSpeed + sqrt(200 * GutsStat) * 0.001; // [m/s]
```

- Target speed when out of HP
- Enforced after start dash ends
- If speed < minimum after acceleration, instantly raised to minimum

### Blocking Speed Cap

When blocked in front by another uma:

```typescript
SpeedCap = (0.988 + 0.012 * (DistanceGap / 2m)) * SpeedOfBlockingUma
```

Linear scaling from 0.988x at 0m to 1.0x at 2m.

## 4. Acceleration System

### Acceleration Formula

```typescript
Accel =
  BaseAccel *
    sqrt(500 * PowerStat) *
    StrategyPhaseCoef *
    GroundTypeProficiencyMod *
    DistanceProficiencyMod +
  SkillModifier +
  StartDashModifier; // [m/s²]
```

### Base Acceleration

- **Normal**: 0.0006 m/s²
- **Uphill**: 0.0004 m/s²

### Strategy Phase Coefficients (for Acceleration)

| Strategy     | Early-race (0) | Mid-race (1) | Late-race (2) & Last Spurt (3) |
| ------------ | -------------- | ------------ | ------------------------------ |
| Front Runner | 1.0            | 1.0          | 0.996                          |
| Pace Chaser  | 0.985          | 1.0          | 0.996                          |
| Late Surger  | 0.975          | 1.0          | 1.0                            |
| End Closer   | 0.945          | 1.0          | 0.997                          |
| Runaway      | 1.17           | 0.94         | 0.956                          |

### Ground Type Proficiency Modifier

| S    | A   | B   | C   | D   | E   | F   | G   |
| ---- | --- | --- | --- | --- | --- | --- | --- |
| 1.05 | 1.0 | 0.9 | 0.8 | 0.7 | 0.5 | 0.3 | 0.1 |

### Distance Proficiency Modifier (for Acceleration)

| S   | A   | B   | C   | D   | E   | F   | G   |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 0.6 | 0.5 | 0.4 |

### Start Dash

During start dash: **+24.0 m/s²** additional acceleration.

**Ends when**: Speed reaches `0.85 * BaseSpeed`

**Post-Start Dash**: Usually unable to accelerate to minimum speed in 1 frame → speed raised to minimum.

## 5. Deceleration Rates

| Condition            | Deceleration                    |
| -------------------- | ------------------------------- |
| Early-race (Phase 0) | -1.2 m/s²                       |
| Mid-race (Phase 1)   | -0.8 m/s²                       |
| Late-race (Phase 2)  | -1.0 m/s²                       |
| Out of HP            | -1.2 m/s² (overrides all above) |

## 6. HP/Stamina System

### Maximum HP Conversion

```typescript
MaxHP = 0.8 * StrategyCoefficient * StaminaStat + CourseDistance; // [m]
```

### Strategy Coefficients

| Front Runner | Pace Chaser | Late Surger | End Closer | Runaway |
| ------------ | ----------- | ----------- | ---------- | ------- |
| 0.95         | 0.89        | 1.0         | 0.995      | 0.86    |

### HP Consumption Per Second

```typescript
HPConsumption =
  ((20.0 * pow(CurrentSpeed - BaseSpeed + 12.0, 2)) / 144.0) * StatusModifier * GroundModifier;
```

### Status Modifiers (multiplicative)

- **1.6x** during `rushed` (kakari)
- **0.6x** when position keeping is `pace-down`
- **0.4x** when in downhill accel mode

### Ground Modifiers for HP Consumption

| Surface | Firm | Good | Soft | Heavy |
| ------- | ---- | ---- | ---- | ----- |
| Turf    | 1.0  | 1.0  | 1.02 | 1.02  |
| Dirt    | 1.0  | 1.0  | 1.01 | 1.02  |

### Late-Race Guts Modifier

In late-race (Phase 2) and last spurt (Phase 3):

```typescript
GutsModifier = 1.0 + 200 / sqrt(600 * GutsStat);
```

Examples:

- 200 Guts: `1.577x`
- 400 Guts: `1.408x`
- 600 Guts: `1.333x`

### HP Recovery Skills

- All HP recovery skills restore **percentage of max HP** instantly
- HP over max is wasted
- Functions identically outside trigger conditions and amounts

### Out of HP

When HP ≤ 0: target speed set to minimum speed.

## 7. Skill System Architecture

### Skill Activation Chance (Pre-Race Wisdom Check)

```typescript
ActivationChance = max(100 - 9000 / BaseWit, 20); // [%]
```

**Critical**: Uses **base wit stat** (NOT adjusted by strategy proficiency or skills).

Examples:

- 300 Wit: `70.0%`
- 600 Wit: `85.0%`
- 900 Wit: `90.0%`
- 1200 Wit: `92.5%`

### Skill Conditions Implementation Patterns

#### x_random

Randomly picks a 10m segment before race starts. Activates when all other conditions fulfilled while on segment.

#### straight_random

1. Randomly pick a straight segment (equal chance regardless of length)
2. Within that straight, randomly pick a 10m segment

#### corner_random

If race goes through same corner multiple times, activates on **last lap**.

#### all_corner_random

Places up to 4 triggers via procedure:

1. All corners start as candidates
2. Randomly select one (equal chance regardless of length)
3. Place 10m trigger at random position within corner
4. If ≥10m remaining after trigger, replace candidate with remaining length; else discard
5. Remove all candidates before selected corner
6. Repeat until 4 triggers placed or no candidates remain

#### phase_corner_random

All corners in corresponding phase "stitched together" → probability proportional to corner length.

#### phase Condition

**Checked BEFORE game updates uma's phase.**

Special case: `phase==1 && corner==0` can activate if uma exits corner and enters late-race on same frame.

#### remain_distance Condition

```typescript
remain_distance = floor(CourseDistance) - floor(CurrentPosition);
```

**Important**: `remain_distance >= 399` can trigger at `remain_distance >= 398.000001`

#### order_rate Conditions

Converted to order, rounding to nearest.

Example: `order_rate > 50` in 9-uma race → 9\*50%=4.5 → converted to `order > 5` (6th place or below).

**order_rate_inXX_continue**: Must remain in top XX% until activation. First 5 seconds don't count.

#### near_count

Uma considered near if:

```
abs(DistanceGap) < 3m
abs(LaneGap) < 3 HorseLane
```

#### is_surrounded

Uma must have another uma in all 3 directions (same uma can fulfill multiple):

- **Out**: `abs(DistanceGap) < 1.5m; 0 < LaneGap < 3 HorseLane`
- **Front**: `0 < DistanceGap < 3.0m; abs(LaneGap) < 1.5 HorseLane`
- **Behind**: `-3.0m < DistanceGap < 0; abs(LaneGap) < 1.5 HorseLane`

#### behind_near_lane_time, infront_near_lane_time

Uma considered closely behind if:

```
abs(DistanceGap) < 2.5m
abs(LaneGap) < 1 HorseLane
```

Check performed on uma 1 place ahead/behind. Timer resets if placement changes.

#### activate_count_x

Skills activate in **ID order**. Lower ID can trigger higher ID on same frame, but not vice versa.

### Skill Duration and Cooldown Scaling

```typescript
Duration = (BaseDuration * CourseDistance) / 1000;
Cooldown = (BaseCooldown * CourseDistance) / 1000;
```

### Skill Level Multipliers

| Level | Target Speed | Accel | Stat | Other (Recovery, CurrentSpeed, Lane) |
| ----- | ------------ | ----- | ---- | ------------------------------------ |
| 1     | 1.00         | 1.00  | 1.00 | 1.00                                 |
| 2     | 1.01         | 1.02  | 1.01 | 1.02                                 |
| 3     | 1.04         | 1.04  | 1.02 | 1.04                                 |
| 4     | 1.07         | 1.06  | 1.03 | 1.06                                 |
| 5     | 1.10         | 1.08  | 1.04 | 1.08                                 |
| 6     | 1.13         | 1.10  | 1.05 | 1.10                                 |
| 7     | 1.16         | 1.125 | 1.06 | 1.12                                 |
| 8     | 1.19         | 1.15  | 1.07 | 1.14                                 |
| 9     | 1.22         | 1.175 | 1.08 | 1.16                                 |
| 10    | 1.25         | 1.20  | 1.10 | 1.18                                 |

### Key Ability Types

#### CurrentSpeed (21)

Two speed variables exist:

- **Current Speed** (LastSelfSpeed): Direct result after acceleration, used for HP consumption, fed into next acceleration
- **Actual Speed** (LastSpeed): Current speed with modifiers applied, used for distance traveled and blocking/overtaking

CurrentSpeed ability modifies Actual Speed **instantly** without acceleration/deceleration needed.

#### CurrentSpeedWithNaturalDeceleration (22)

Two-part effect:

1. Modifier increasing actual speed (like CurrentSpeed)
2. When first modifier expires, adds one-time modifier of equal magnitude to current speed

### Value Scaling Types

#### Direct (1)

No scaling.

#### MultiplySkillNum (2)

```typescript
ScaledValue = min(1 + 0.01 * NumSkill, 1.2);
```

#### Aoharu Skills (3-7)

Scales with team's total base stats:

- Total < 1200: 0.8x
- 1200 ≤ Total < 1800: 0.9x
- 1800 ≤ Total < 2600: 1.0x
- 2600 ≤ Total < 3600: 1.1x
- 3600 ≤ Total: 1.2x

#### Multiply Random (8, 9)

Both types identical:

- 60%: 0.0x
- 30%: 0.02x
- 10%: 0.04x

#### Climax Skills (10)

Scales with races won during training:

- Wins < 6: 0.8x
- 6 ≤ Wins < 14: 0.9x
- 14 ≤ Wins < 18: 1.0x
- 18 ≤ Wins < 25: 1.1x
- 25 ≤ Wins: 1.2x

#### MultiplyMaximumRawStatus (13)

Scales with maximum raw stat of all 5 stats:

- Stat < 600: 0.8x
- 600 ≤ Stat < 800: 0.9x
- 800 ≤ Stat < 1000: 1.0x
- 1000 ≤ Stat < 1100: 1.1x
- 1100 ≤ Stat: 1.2x

#### MultiplyActivateSpecificTagSkillCount (14)

Scales with number of green skills (tag 601-615) activated:

- 0-2 skills: 0.0x
- 3-4 skills: 1.0x
- 5 skills: 2.0x
- 6+ skills: 3.0x

#### AddDistanceDiffTop (19)

- Distance < 20m: +0.0
- Distance ≥ 20m: +0.1

#### MultiplyBlockedSideMaxContinueTimePhaseMiddleRun (20, 21)

Scales with max duration of side blocking during mid-race. Timer resets when both sides clear.

Type 1 (ID=20):

- Blocked < 2s: 1.0x
- Blocked < 4s: 2.0x
- Blocked < 6s: 3.0x
- Blocked ≥ 6s: 4.0x

Type 2 (ID=21): Not implemented.

#### MultiplySpeed (22, 23)

Scales with final speed stat (including all modifiers and skills).

Type 1 (ID=22):

- Speed < 1700: 0.0x
- 1700 ≤ Speed < 1800: 1.0x
- 1800 ≤ Speed < 1900: 2.0x
- 1900 ≤ Speed < 2000: 3.0x
- 2000 ≤ Speed: 4.0x

Type 2 (ID=23):

- Speed < 1400: 1.0x
- 1400 ≤ Speed < 1600: 2.0x
- 1600 ≤ Speed: 3.0x

#### MultiplyArcGlobalPotentialLevel (24)

Scales with L'arc scenario global potential level:

- Lv < 10: 1.0x
- 10 ≤ Lv < 20: 1.1x
- 20 ≤ Lv: 1.2x

#### MultiplyTopLeadAmount (25)

Scales with max lead between 0-66.6% of course:

- Lead < 10m: 1.0x
- 10m ≤ Lead < 25m: 1.4x
- 25m ≤ Lead: 1.8x

### Duration Scaling Types

#### Direct (1)

No scaling.

#### MultiplyDistanceDiffTop (2)

```typescript
ScaledDuration = BaseDuration * min(0.8 + DistanceFromTop / 62.5, 1.6);
```

#### MultiplyRemainHp (3, 7)

Type 1 (ID=3, Mejiro Bright/McQueen):

- HP < 2000: 1.0x
- 2000 ≤ HP < 2400: 1.5x
- 2400 ≤ HP < 2600: 2.0x
- 2600 ≤ HP < 2800: 2.2x
- 2800 ≤ HP < 3000: 2.5x
- 3000 ≤ HP < 3200: 3.0x
- 3200 ≤ HP < 3500: 3.5x
- 3500 ≤ HP: 4.0x

Type 2 (ID=7, Matikane Tannhauser):

- HP < 1500: 1.0x
- 1500 ≤ HP < 1800: 1.5x
- 1800 ≤ HP < 2000: 2.0x
- 2000 ≤ HP < 2100: 2.5x
- 2100 ≤ HP: 3.0x

#### IncrementOrderUp (4)

Duration increases by **1 second per successful overtake** while active (up to 3 times). Applies to all modifiers. Additional duration also scales with course distance.

#### MultiplyBlockedSideMaxContinueTimePhaseMiddleRun (5, 6)

Same logic as ability value counterpart.

Type 1 (ID=5):

- Blocked < 2s: 1.0x
- Blocked < 4s: 2.0x
- Blocked < 6s: 3.0x
- Blocked ≥ 6s: 4.0x

Type 2 (ID=6): Not implemented.

### Additional Activate

Effects that trigger during skill duration when conditions met (can trigger multiple times).

#### OrderUp (1)

Triggered each time uma successfully overtakes. **Up to 3 times.**

#### AdditionalActivateActivateAnySkill (2, 3)

Triggered each time uma activates another skill.

- Type 1 (ID=2): up to 3 times
- Type 2 (ID=3): up to 2 times

### Skill Target Rules

- Skills don't distinguish friend and foe for targeting
- Teammates count towards skill's maximum target
- Teammates **excluded** from debuff effects

## 8. Lane Mechanics

### Lane Measurement

- Distance from inner fence in **course width** units (1 course width = 11.25m)
- **Horse lane** = 1/18 course width = 0.625m
- Minimum lane: 0
- Maximum lane: varies by course (1.1 to 1.5 course width)

### Initial Lane Position

```typescript
InitialLane = HorseIndex * HorseLane + Adjustor;
```

Adjustor:

- Ooi: 0
- Longchamp (gate ≥ 14): 1.86
- Other JRA (gate ≥ 10): 0.6

### Lane Change Speed

Three components: target speed, current speed, actual speed.

**Target Speed**:

```typescript
TargetSpeed = 0.02 * (0.3 + 0.001 * PowerStat) * FirstMoveLanePointMod * OrderMod;
```

- **FirstMoveLanePointMod** (early/mid-race, before move lane point):
  ```typescript
  FirstMoveLanePointMod = 1 + (LaneDistance / MaxLaneDistance) * 0.05;
  ```
- **OrderMod** (late-race & last spurt):
  ```typescript
  OrderMod = 1 + Order * 0.01;
  ```

**Current Speed**:

- Not directional
- Acceleration: constant **0.03** (0.02 \* 1.5)
- Resets to 0 when target lane reached
- Continues building if blocked

**Actual Speed**:

```typescript
ActualSpeed = clamp(CurrentSpeed + SkillModifier, 0, 0.6) * DirectionModifier;
```

Direction modifiers:

- Moving out: 1
- Moving in: `-(1 + LaneDistance)`

### Target Lane Determination

Updated when <0.5 horse lane from current target OR blocked on side trying to move.

Three strategies: **Normal**, **Overtake**, **Fixed**

#### Overtake Targets Definition

All visible uma 1-20m ahead where:

- `DistanceGap / SpeedGap < 15` (catchable in 15s)
- AND (target speed < yours OR blocked and current speed < your target speed)
- OR closest uma blocking in front (automatically a target)

### Normal Mode

Used when no overtake targets OR within 200m before move lane point in early/mid-race.

Rules (in order):

1. If out of HP: target = current lane
2. If pace-down mode: target = 0.18
3. If final straight and extra move lane on outside: target = extra move lane (if not blocked)
4. If early/mid-race: target = current - 0.05 (if not blocked)
5. If mid-race and <1.75 horse lane from inside uma: target = 2.0 horse lane from inside uma
6. Otherwise: keep straight

### Overtake Mode

Used when overtake targets exist. Stays active 1.5s after losing all targets.

**Process**:

1. For each overtake target, find innermost/outermost uma of their crowd:

   ```
   0.0 ≤ DistanceGap ≤ 3.0
   0 < LaneGap < 2 HorseLane
   ```

2. Candidate = lane ± 1 horse lane from inner/outermost uma

3. Validate no visible uma in:

   ```
   OwnerDistance ≤ Distance ≤ Inner/OutermostUmaDistance + 0.5
   CandidateLane - 0.8HL ≤ LaneDistance ≤ CandidateLane + 0.8HL
   ```

4. Additional candidate:
   - Early/mid-race and ≥1 horse lane from fence: 1 horse lane in
   - Otherwise: straight

5. Validate additional candidate in:

   ```
   OwnerDistance ≤ Distance ≤ FurthestTargetDistance + 3.0
   CandidateLane - 0.8HL ≤ LaneDistance ≤ CandidateLane + 0.8HL
   ```

6. Score remaining candidates:
   ```typescript
   Score = abs(CandidateLane - LaneDistance) * PhaseCoef;
   ```

Phase coefficients:

- Early-race: In=1.0, Out=100.0
- Mid-race: In=1.0, Out=1.0
- Late-race/last spurt: In=1.0, Out=1.15

7. Accept lowest score (or current lane if all bad)

8. If accepted < extra move lane and space available: use extra move lane

### Fixed Mode

Used when skill affects target lane. Target = skill-specified lane unless blocked.

### Extra Move Lane (Final Corner Lane)

Set upon entering final corner:

```typescript
ExtraMoveLane = clamp(LaneDistance / 0.1, 0, 1) * 0.5 + random(0.1);
```

**Pre-1st anniversary**: Activated on final straight instead.

### Blocking

#### Front Blocking

Uma blocks in front if:

```
0 < DistanceGap < 2m
abs(LaneGap) ≤ (1.0 - 0.6 * DistanceGap / 2m) * 0.75 HorseLane
```

Lane gap: 0.3 horse lane at 2m ahead, 0.75 horse lane at 0m.

If multiple satisfy, lowest distance gap is blocking uma.

Speed limited to:

```typescript
SpeedLimit = (0.988 + 0.012 * (DistanceGap / 2m)) * SpeedOfBlockingUma
```

#### Side Blocking

Uma blocks on side if:

```
abs(DistanceGap) < 1.05m
abs(LaneGap) < 2 HorseLane
```

Lowest lane gap determines available movement space.

**"All sides" blocked**: Front AND at least one side.

#### Overlapping

Two uma overlap if:

```
abs(DistanceGap) < 0.4m
abs(LaneGap) < 0.4 HorseLane
```

Outside uma immediately bumped 0.4 horse lane away. Triggers target lane update for outside uma.

### Vision

Uma is visible if:

```
DistanceGap ≤ VisibleDistance
abs(LaneGap) ≤ ((DistanceGap / VisibleDistance) * 11.5HL + 2HL) / 2
```

Visible distance starts at **20m**, modified only by skills.

Maximum vision cone width constant regardless of visible distance.

## 9. Position Keeping System

Affects target speed between sections 1-10. Five modes besides normal: speed up, overtake, pace up, pace down, pace up Ex.

**Check Frequency**: Every 2 seconds when in normal mode.

**Duration**: Length of 1 section (3 sections for oonige). Distance rounded down before multiplying.

**Cooldown**: 1 second after exiting, then 2 second interval (total 3 seconds).

### Pacemaker

Non-front runner modes determined by distance from pacemaker. Selection mechanism unclear. Known parameters: range=10.0, count=2.0.

**Pre-1.5 anniversary**: Pacemaker = first place uma among most forward strategy.

### Front Runner Modes

#### Speed Up Mode

- **Target speed modifier**: 1.04x
- **Entry**: First place AND <4.5m (17.5m oonige) ahead of uma behind, pass wisdom check
  - Increased to 12.5m if only front runner (post-1.5 anniversary)
- **Wisdom check**: `20 * log10(WitStat * 0.1) [%]`
- **Exit**: >4.5m (17.5m oonige) ahead of second place
  - Increased to 12.5m if only front runner (post-1.5 anniversary)

#### Overtake Mode

- **Target speed modifier**: 1.05x
- **Entry**: Not first place within same strategy, pass wisdom check
- **Wisdom check**: `20 * log10(WitStat * 0.1) [%]`
- **Exit**: 10m (27.5m oonige) ahead of second place among same strategy

### Non-Front Runner Modes

Distance thresholds from pacemaker:

```typescript
CourseFactor = 0.0008 * (CourseLength - 1000) + 1.0;
```

| Strategy    | Min Distance        | Max Distance        |
| ----------- | ------------------- | ------------------- |
| Pace Chaser | 3.0m                | 5.0 \* CourseFactor |
| Late Surger | 6.5 \* CourseFactor | 7.0 \* CourseFactor |
| End Closer  | 7.5 \* CourseFactor | 8.0 \* CourseFactor |

#### Pace Up Mode

- **Target speed modifier**: 1.04x
- **Entry**: Distance from 1st > max distance, pass wisdom check
- **Wisdom check**: `15 * log10(WitStat * 0.1) [%]`
- **Exit**: Distance from 1st < random(min, max)

#### Pace Down Mode

- **Target speed modifier**: 0.945x (mid-race post-1.5 anniv), 0.915x (otherwise)
- **Entry**: Distance from 1st < min distance, no target/current speed up skill active
- **Exit**: Distance from 1st > random value OR speed up skill activates
  - Mid-race post-1.5 anniv: max replaced with `lerp(min, max, 0.5)` before rolling
  - **Bug fixed 2022-08-09**: Debuffs no longer remove pace down mode

### Pace Up Ex Mode

- **Target speed modifier**: 2.0x
- **Entry (front runner)**: Another uma whose strategy should be behind is ahead
- **Entry (others)**: Pacemaker's strategy should be behind
- **Exit**: No uma whose strategy should be behind is ahead
- **Priority**: Overrides all other position keep modes
- **Added**: After 1.5 anniversary

## 10. Special Mechanics

### Rushed (Kakari / Temptation)

Pre-race roll:

```typescript
RushedChance = pow(6.5 / log10(0.1 * WitStat + 1), 2); // [%]
```

Examples:

- 300 Wiz: 19.00%
- 600 Wiz: 13.26%
- 900 Wiz: 11.01%
- 1200 Wiz: 9.74%

**自制心 skill**: -3% flat (e.g., 19% → 16%)

**Trigger**: Random section 2-9, enters immediately upon entering section.

**Effects**:

- HP consumption: **1.6x**
- Forces position keep mode, succeeds all position keep wisdom rolls
- Strategy forced (AI only, doesn't affect coefficients):
  - Front Runner → speed up mode
  - Pace Chaser → runner
  - Late Surger → 75% runner, 25% leader
  - End Closer → 70% runner, 20% leader, 10% betweener

**Duration**:

- 55% escape chance every 3 seconds
- Max 12 seconds
- Debuffs worsening rushed extend timer by 5s (can apply multiple times)

### Start Delay / Late Start

**Start Delay**: Random 0-0.1s (NOT affected by wisdom)

**Late Start**: Delay >0.08s

**Fast Start**: Delay <0.02s (team stadium score bonus)

**Skills Affecting Start Delay**:

- アタシに指図しないで！！: fixed 0.085s
- 超遊び癖: fixed 0.1s
- Concentration (コンセントレーション): 0.4x
- Focus (集中力): 0.9x
- Gatekept (ゲート難): 1.5x

**If delay <1 frame** (0.0666s):

- Acceleration and HP consumption: normal
- Distance traveled: `SpeedAfterAccel * (1 frame - StartDelay)`

**If delay ≥1 frame**:

- No acceleration, HP consumption, or distance traveled
- Significant acceleration loss may cause blocking
- Note: 0.066s-0.08s has no late start warning

### Lead Competition (CompeteTop)

**Trigger**: Sections 1-6, 150m from start, 2+ front runners or oonige

**Position Requirements**:

- Front Runner: `DistanceGap < 3.75m; LaneGap < 0.165 * CourseWidth`
- Oonige: `DistanceGap < 5.0m; LaneGap < 0.416 * CourseWidth`

Note: Front runners don't compete with oonige.

**Effects**:

```typescript
TargetSpeed += pow(500 * GutsStat, 0.6) * 0.0001; // [m/s]
Duration = pow(700 * GutsStat, 0.5) * 0.012; // [s]
```

Always ends at section 9 regardless of duration.

**HP Consumption Multipliers**:

- Front Runner: 1.4x
- Front Runner + Rushed: 3.6x
- Oonige: 3.5x
- Oonige + Rushed: 7.7x

### Dueling (Compete Fight)

**Trigger**: Final straight, 2+ uma close for 2+ seconds

**Competition Target**:

```
abs(DistanceGap) < 3.0m
abs(LaneGap) < 0.25 CourseWidth
```

**Additional Requirements**: Top 50% placement, `abs(SpeedGap) < 0.6 m/s`

**Effects**:

```typescript
TargetSpeed += pow(200 * GutsStat, 0.708) * 0.0001; // [m/s]
Accel += pow(160 * GutsStat, 0.59) * 0.0001; // [m/s²]
```

**HP Requirements**:

- Cannot occur below 15% HP
- Ends below 5% HP

### Conserve Power / Fully Charged

**Requirement**: Base power + skill bonus >1200

**Build Conserved Power** (every 1.5s, possibly scales with course length):

- ID 1. Position Keep Pace Down: +6.7
- ID 2. Position Keep Normal: +4.2

**Decrease Conserved Power**:

- ID 3. Lead Competition: -0.95
- ID 4. Rushed: -0.8

Decrease also affected by:

- Lane Move Speed Up skills (28)
- Speed Up skills (27, 31, 21, 22)

**Last Spurt Acceleration Bonus**:

```typescript
Accel = sqrt((PowerStat - 1200) * 130) * 0.001 * StrategyDistCoef * ActivityCoef;
```

Power stat = base power (not halved >1200) + skill bonus.

**Strategy-Distance Coefficients**:

| Strategy     | Short | Mile | Mid   | Long |
| ------------ | ----- | ---- | ----- | ---- |
| Front Runner | 1.0   | 1.0  | 1.0   | 1.0  |
| Pace Chaser  | 0.7   | 0.8  | 0.9   | 0.9  |
| Late Surger  | 0.75  | 0.7  | 0.875 | 1.0  |
| End Closer   | 0.7   | 0.75 | 0.86  | 0.9  |

**Activity Coefficients**:

- ID 3. Lead competition: 0.98
- ID 4. Rushed: 0.8

**Duration**: ~3 seconds, may depend on conserved power amount.

Related parameters:

- ActivityTimeCoef: 1450
- ActivityTimeDistanceTypeCoef: 0.45 (short), 1.0 (mile), 0.875 (mid), 0.8 (long)

### Compete Before Spurt

**Timing**: Sections 11-15, checked every 2s

**Trigger**: Too far from first place (wisdom-scaled) OR nearby uma (guts-scaled, count-scaled, same-strategy-scaled)

**Distance Thresholds** (should scale with course distance):

| Strategy     | Distance |
| ------------ | -------- |
| Runaway      | 0.0m     |
| Front Runner | 0.0m     |
| Pace Chaser  | 2.5m     |
| Late Surger  | 5.0m     |
| End Closer   | 10.0m    |

**Effects** (2s active, 1s cooldown):

```typescript
TargetSpeedIncrease = ((Power / 1500) ^ (0.5 * 2.0 + Guts / 3000) ^ 0.2) * 0.1 * StrategyCoef;
```

**Strategy Coefficients**:

| Strategy     | Speed Coefficient | Stamina Coefficient |
| ------------ | ----------------- | ------------------- |
| Runaway      | 0.2               | 1.5                 |
| Front Runner | 0.8               | 1.2                 |
| Pace Chaser  | 1.0               | 1.0                 |
| Late Surger  | 1.0               | 1.0                 |
| End Closer   | 1.0               | 1.0                 |

**Stamina Consumption**:

```typescript
StaminaConsumption = 20 * (StrategyCoef * DistanceCoef + NearFactor);
```

**Distance Coefficients**:

- Distance < 1401m: 0.3x
- Distance < 1801m: 0.3x [sic]
- Distance < 2101m: 0.5x
- Distance < 2201m: 0.8x
- Distance < 2401m: 1.0x
- Distance < 2601m: 1.1x
- Distance ≥ 2601m: 1.2x

**Near Factor**: 0.5 if mode activated due to nearby uma (not far from first).

**Solo Bonus** (front runner, no same-strategy uma within 10m, unexplained 20% threshold):

| Strategy     | Coefficient |
| ------------ | ----------- |
| Runaway      | 2.0         |
| Front Runner | 1.1         |

#### Stamina Keep

Uma conserves random 1.035-1.04x required HP to finish. Every 2s, if HP insufficient:

```typescript
NoticeChance = 30% * (Wisdom/1000 + pow(Wisdom, 0.03))
```

Formula highly speculative. Parameters: 30%, 1000 divisor, 0.03 exponent.

**Testing**: 93/100 immediate activations at 1000 wisdom (higher than formula predicts).

If noticed, enter stamina keep mode → won't participate in competition.

HP recovery skill resets state → competition can activate if HP now sufficient.

### Secure Lead

**Timing**: Sections 11-15, checked every 2s

**Trigger**: Lead against uma who should be behind <desirable, 20% chance (should scale with wisdom, mechanics unknown)

```typescript
DesirableLead = StrategyCoef + 0.0003 * (CourseDistance + 1000); // [m]
```

**Desirable Lead Strategy Coefficients**:

| Row \ Col    | Front Runner | Pace Chaser | Late Surger | End Closer |
| ------------ | ------------ | ----------- | ----------- | ---------- |
| Runaway      | 2.0          | 7.0         | 8.0         | 8.0        |
| Front Runner | -            | 4.0         | 8.0         | 8.0        |
| Pace Chaser  | -            | -           | 5.0         | 6.0        |
| Late Surger  | -            | -           | -           | 3.0        |

**Effects** (2s active, 1s cooldown):

```typescript
TargetSpeedIncrease = pow(Guts / 2000, 0.5) * 0.3 * StrategyCoef; // [m/s]
```

**Strategy Coefficients**:

| Strategy     | Speed Coefficient | Stamina Coefficient |
| ------------ | ----------------- | ------------------- |
| Runaway      | 0.2               | 1.2                 |
| Front Runner | 1.0               | 1.0                 |
| Pace Chaser  | 1.0               | 0.8                 |
| Late Surger  | 0.8               | 0.8                 |

**Stamina Consumption**:

```typescript
StaminaConsumption = 20 * StrategyCoef * CourseDistanceCoef;
```

**Course Distance Coefficients**: Same as Compete Before Spurt.

**Solo Bonus** (nige, no same-strategy uma within 10m, unexplained 20% threshold):

| Strategy     | Coefficient |
| ------------ | ----------- |
| Runaway      | 7.0         |
| Front Runner | 2.0         |

### Stamina Limit Break

**Requirement**: Base stamina + skill bonus >1200, distance ≥2101m

**Effect**: Additional target speed buff upon reaching max spurt speed, lasts till end of race.

```typescript
TargetSpeedBuff = sqrt(StaminaStat - 1200) * 0.0085 * DistanceFactor * RandomFactor; // [m/s]
```

**Distance Factors**:

- Distance < 2101m: 0.0x
- Distance < 2201m: 0.5x
- Distance < 2401m: 1.0x
- Distance < 2601m: 1.5x (1.2x before 2024-10-29)
- Distance ≥ 2601m: 1.8x (1.5x before 2024-10-29)

**Random Factor** (mechanism unclear):

- Parameter: "TargetSpeedRandomTableChangeProbabilityByPower": 500

| Table Type | Probability | Coefficient |
| ---------- | ----------- | ----------- |
| 0          | 500000      | 0.98-1.00   |
| 1          | 300000      | 0.95-0.98   |
| 2          | 200000      | 1.00-1.02   |

## 11. Course & World Transform

### Course Structure

**1001 keyframes**: 1000 equal-distance segments.

Each keyframe: 3D coordinate + rotation quaternion.

**Position Calculation**:

```typescript
frame = Distance / CourseDistance * 1000
PosLaneOrigin = lerp(Pos[floor(frame)], Pos[ceil(frame)], frame - floor(frame))
Pos = PosLaneOrigin + CourseRotation * RotationLaneOrigin * (11.25m * Lane)
```

Lane offset: perpendicular to rotation (left if clockwise, right if counter-clockwise).

### Distance Ratio

```typescript
ratio = DistanceWorld / DistanceCourse;
```

**Base ratio**: Ratio between 0m-1m at lane origin (ranges 0.96-1.06 among courses).

**Per-frame adjustment**:

```typescript
DistanceAddWorld = DistanceAddCourse / max(1, ratioPrev / ratioBase);
```

**Effect**: Running outside lane while cornering or moving lanes → travel additional distance (modeled as less course distance progress).

### Course Events

11 event types defining course parameters:

| ID  | Name                 | Attributes                                   | Notes                                                                               |
| --- | -------------------- | -------------------------------------------- | ----------------------------------------------------------------------------------- |
| 0   | Corner               | Corner Number (1-4); Distance                |                                                                                     |
| 1   | Ground Change        |                                              | Turf to dirt change                                                                 |
| 2   | Straight             | Start/End; Type (Front=1, Across=2, False=3) | 2 events per straight                                                               |
| 3   | Lane Max Change      | New value                                    | Change max lane                                                                     |
| 4   | First BGM Landscape  |                                              | Purpose before landscape mode unknown                                               |
| 5   | Second BGM Landscape |                                              |                                                                                     |
| 6   | Jikkyo Trigger       |                                              | Unused                                                                              |
| 7   | Move Lane Point      |                                              | When uma can move out; defaults to initial corner entry; only seen in Niigata 1000m |
| 8   | First BGM            |                                              |                                                                                     |
| 9   | Second BGM           |                                              |                                                                                     |
| 10  | Event Crowd          |                                              | Unused                                                                              |
| 11  | Slope                | SlopePer; Length                             |                                                                                     |

### Slope Effects

**Uphill**: Target speed loss

```typescript
TargetSpeedLoss = (SlopePer * 200) / PowerStat;
```

**Downhill**: Each second, `4% * WitStat` chance to enter downhill accel mode:

- Target speed: `+0.3 + SlopePer/10 [m/s]`
- HP consumption: **-60%**
- 20% chance per second to end

**Slope Detection**: `SlopePer = tan(slopeAngle) * 100`

- Uphill: SlopePer >1.0
- Downhill: SlopePer <-1.0

## 12. Implementation Guidelines

### Calculation Order Per Frame

1. **Pre-Update**
   - Check end of corner

2. **Update**
   - Activate skills
   - Recover HP by skills
   - Update last spurt state
   - Update target speed
   - Calculate acceleration
   - Update phase
   - Calculate distance and position
   - Check for slope

3. **Post-Update**

4. **Events**
   - Check start of corner

### Race Initialization Order

1. Calculate base stats (before initialization)
2. Calculate skill activation chance, determine which skills can activate
3. Activate all out-of-gate skills
4. Use item (unimplemented - could prevent late start)
5. Set starting location by gate number
6. Calculate start delay
7. Calculate adjusted stats
8. Convert stamina to HP
9. Set starting speed
10. Determine rushed

### Common Pitfalls

**Stats**: Clamped at each stage (base, adjusted, final) between 1-2000.

**Skill Activation**: Uses **base wit**, not adjusted (unaffected by strategy proficiency or skills).

**Phase Checking**: Skills check phase **before** game updates uma's phase.

**remain_distance**: Uses `floor()` so `remain_distance >= 399` can trigger at position 398.000001.

**Speed Debuffs**: CurrentSpeed ability applies **instantly** after acceleration calculation.

**Last Spurt**: Recalculates on HP recovery but **NOT** on debuffs (added after 1st anniversary).

**Display Time**: `DisplayedTime = ActualTime * 1.18`

**Raw Stats >1200**: Halved before conversion to base stats.

**Minimum Speed**: Enforced after start dash ends by instantly raising speed if below threshold.

**Blocked Speed**: Applied after all acceleration calculations.

**Vision Cone**: Maximum width constant regardless of visible distance modification.

**Position Keeping**: Only affects sections 1-10, checked every 2s, lasts 1 section length (3 for oonige).

**Overtake Mode**: Stays active 1.5s after losing all overtake targets.

**Extra Move Lane**: Set on entering **final corner** (was final straight pre-1st anniversary).

### Precision Notes

**Floating Point**: All calculations use floating point arithmetic.

**Race Time Bounds**: Each race has lower and upper bound for displayed time. Breaking lower bound adds up to 1s to displayed time.

**Position Recording**:

- Every 1 second normally
- Every frame in first 1 second of race
- Every frame when within 25m of goal

**Lane Width**: Varies by course. Widest: Tokyo turf (1.5). Narrowest: Sapporo/Hakodate/Niigata dirt (1.1).

**Section Distance**: `CourseDistance / 24` (used for position keep duration).

**Frame Time**: Exactly 0.0666... seconds (1/15).

## Code Generation Best Practices

### Type Safety

- Don't use enums for Strategy, Aptitude, Phase
- Clamp all calculated stats explicitly
- Use constants for magic numbers (frame rate, bashin, etc.)

### Formula Implementation

- Break complex formulas into intermediate variables for readability
- Document formula sources with section references
- Add assertions for expected ranges (especially 1-2000 clamping)

### Skill System

- Separate skill condition checking from skill effects
- Implement skill activation chance pre-race
- Maintain skill activation order by ID
- Track skill cooldowns and durations with course distance scaling

### Performance Considerations

- Pre-calculate phase coefficients as lookup tables
- Cache base speed, adjusted stats
- Avoid redundant sqrt/pow calculations
- Consider vectorizing operations for multiple uma

### Testing Patterns

- Verify stat clamping at boundaries (1, 1200, 2000)
- Test phase transitions and skill activation timing
- Validate wisdom-dependent RNG (activation, position keeping, rushed)
- Check edge cases (start dash with uphill, debuff during start dash)
- Confirm last spurt recalculation on HP recovery

### Common Patterns from Codebase

**Strategy Enums**: Don't use enums for Strategy, Aptitude, Phase

From this.

```typescript
export const enum Strategy {
  FrontRunner = 1,
  PaceChaser,
  LateSurger,
  EndCloser,
  Runaway,
}
```

Use this instead:

```typescript
export const Strategy = {
  Runaway: 1,
  'Front Runner': 2,
  'Pace Chaser': 3,
  'Late Surger': 4,
  'End Closer': 5,
} as const;

export type IStrategy = (typeof Strategy)[keyof typeof Strategy];

export const StrategyName = {
  [Strategy.Runaway]: 'Runaway',
  [Strategy.Front Runner]: 'Front Runner',
  [Strategy.Pace Chaser]: 'Pace Chaser',
  [Strategy.Late Surger]: 'Late Surger',
  [Strategy.End Closer]: 'End Closer',
} as const;
```

**Coefficient Arrays**: Use frozen arrays with empty first element

```typescript
const StrategyPhaseCoef = Object.freeze([
  [], // strategies start at 1
  [1.0, 0.98, 0.962], // Front Runner
  // ...
]);
```

**Phase Naming**

Don't use enums.

Phases are named as follows:

- Early Race (Phase 0)
- Mid Race (Phase 1)
- Late Race (Phase 2)
- Last Spurt (Phase 3)

```typescript
export const Phase = {
  EarlyRace: 0,
  MidRace: 1,
  LateRace: 2,
  LastSpurt: 3,
} as const;

export type IPhase = (typeof Phase)[keyof typeof Phase];

export const PhaseName = {
  [Phase.EarlyRace]: 'Early Race',
  [Phase.MidRace]: 'Mid Race',
  [Phase.LateRace]: 'Late Race',
  [Phase.LastSpurt]: 'Last Spurt',
} as const;
```

---

**Reference Document**: docs/race-mechanics.md
**Quick Reference**: docs/quick-reference.md
**Information Source**: Reverse engineering by @umamusu_reveng, @kak_eng, @hoffe_33 and @KuromiAK
